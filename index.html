<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HRSD AI Executive Office</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Include Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-blue: #00A99D;
            --dark-teal: #004F58;
            --text-light: #e0e0e0;
            --text-dark: #ffffff;
            --border-color: rgba(255, 255, 255, 0.2);
            --container-bg: rgba(0, 30, 60, 0.5);
            --container-bg-light: rgba(255, 255, 255, 0.08);
            --mobile-header-height: 60px; /* Define mobile header height */
            --mobile-footer-height: 70px; /* Define mobile footer height */
            --vh: 1vh;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            -webkit-tap-highlight-color: transparent;
             box-sizing: border-box; /* Added for easier layout */
        }

        html, body {
             height: 100%; /* Ensure html and body take full height */
             margin: 0;
             padding: 0;
             overflow: hidden; /* Prevent scrolling on body */
        }


        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--dark-teal);
            color: var(--text-light);
            background-image: url('https://images.unsplash.com/photo-1550745165-9bc0b252726a?q=80&w=1920&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            display: flex;
            flex-direction: column;
            /* Use dynamic viewport height */
             height: calc(var(--vh, 1vh) * 100);
        }

        body::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 50% 50%, rgba(0, 79, 88, 0.1) 0%, rgba(0, 79, 88, 0.8) 70%, #00282d 100%);
            z-index: -1;
        }

        .header {
             /* Common header styles */
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px; /* Default padding */
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(0, 40, 45, 0.8); /* Darker semi-transparent */
            backdrop-filter: blur(15px);
            position: sticky;
            top: 0;
            z-index: 1000;
            height: var(--mobile-header-height); /* Use variable */
            flex-shrink: 0; /* Prevent header from shrinking */
        }


        .header-left, .header-right {
            display: flex;
            align-items: center;
            gap: 15px; /* Default gap */
        }

        .header-left img.hrsd-logo {
            height: 35px; /* Slightly smaller for mobile first */
            width: auto;
        }
        .header-left span { display: none; } /* Hide text by default */

        .header-right .user-profile { display: none; } /* Hide profile by default */

        .header-right button {
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.3rem; /* Larger icons */
            cursor: pointer;
            padding: 5px;
            transition: color 0.2s;
            line-height: 1; /* Ensure icons align */
        }
        .header-right button:hover {
            color: var(--primary-blue);
        }

        .mobile-menu-btn { display: block; } /* Show hamburger by default */
        #newChatBtn { display: block; } /* Show new chat icon */

        /* Desktop Header Adjustments */
        @media (min-width: 769px) {
            .header {
                padding: 15px 40px;
                height: auto; /* Allow natural height */
            }
            .header-left span { display: inline; font-weight: 500; font-size: 1.2rem; margin-left: 10px;}
            .header-left img.hrsd-logo { height: 50px; }
            .header-right .user-profile { display: flex; align-items: center; gap: 10px; }
             .header-right .user-profile img { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--primary-blue); }
            .header-right .user-profile span { font-weight: 500; display: inline; }
            .mobile-menu-btn { display: none; }
            #newChatBtn { display: none; } /* Hide mobile new chat on desktop */
            .nav-tabs-container { display: flex; /* Show desktop tabs */}
             .mobile-nav-overlay { display: none; } /* Hide mobile nav overlay */
        }

        /* Desktop Navigation Tabs */
        .nav-tabs-container {
            display: none; /* Hidden by default (mobile first) */
            justify-content: center;
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
            position: sticky; /* Make tabs sticky below header */
            top: var(--mobile-header-height); /* Stick below header */
             background-color: rgba(0, 40, 45, 0.8);
            backdrop-filter: blur(15px);
            z-index: 900;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        @media (min-width: 769px) {
            .nav-tabs-container {
                 top: 83px; /* Adjust sticky position for desktop header */
            }
        }


        .nav-tabs {
            display: flex;
            gap: 5px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-tabs button {
            background: none;
            border: none;
            padding: 10px 20px;
            font-size: 0.9rem;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 25px;
            border: 1px solid transparent;
            position: relative;
            overflow: hidden;
        }
        /* Desktop Tab styles */
        .nav-tabs button::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(0, 169, 157, 0.2), transparent); transition: left 0.5s; }
        .nav-tabs button:hover::before { left: 100%; }
        .nav-tabs button.active { color: var(--text-dark); background: linear-gradient(135deg, var(--primary-blue), #008a7e); font-weight: 500; box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4); border-color: rgba(0, 169, 157, 0.3); }
        .nav-tabs button:hover:not(.active) { background-color: var(--container-bg-light); border-color: var(--border-color); transform: translateY(-2px); }

        /* Mobile Navigation Overlay / Sidebar */
        .mobile-nav-overlay {
            position: fixed;
            top: 0;
            left: -100%; /* Start off-screen */
            width: 80%;
            max-width: 300px;
            height: 100%;
            background-color: var(--dark-teal);
            z-index: 1100;
            transition: left 0.3s ease-in-out;
            box-shadow: 4px 0px 15px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            padding-top: var(--mobile-header-height); /* Space for header */
        }
        .mobile-nav-overlay.active {
            left: 0; /* Slide in */
        }
        .mobile-nav-menu {
            list-style: none;
            padding: 20px;
            margin: 0;
        }
        .mobile-nav-menu li a {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 10px;
            color: var(--text-light);
            text-decoration: none;
            font-size: 1rem;
            border-radius: 8px;
            transition: background-color 0.2s, color 0.2s;
        }
         .mobile-nav-menu li a i {
             width: 20px; /* Align icons */
             text-align: center;
             opacity: 0.8;
         }
        .mobile-nav-menu li a:hover,
        .mobile-nav-menu li a.active {
            background-color: var(--primary-blue);
            color: var(--text-dark);
            font-weight: 500;
        }
        .mobile-nav-menu li a.active i,
        .mobile-nav-menu li a:hover i {
             opacity: 1;
        }

        /* Backdrop for mobile nav */
        .nav-backdrop {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0, 0, 0, 0.5);
             z-index: 1050; /* Below nav, above content */
             opacity: 0;
             visibility: hidden;
             transition: opacity 0.3s, visibility 0.3s;
        }
        .nav-backdrop.active {
            opacity: 1;
            visibility: visible;
        }


        /* Main Content Area */
        .main-container {
            flex-grow: 1; /* Takes remaining vertical space */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Prevent this container from scrolling */
        }

        .page-content {
            display: none;
            flex-grow: 1;
            overflow-y: auto; /* Allow individual pages to scroll */
            padding: 15px; /* Mobile padding */
             height: calc(100% - var(--mobile-header-height)); /* Full height minus header */
        }
        .page-content.active {
            display: flex;
        }

         /* Agent page specific layout for mobile */
         #agent-page {
             padding: 0; /* Remove padding for edge-to-edge chat */
              height: calc(calc(var(--vh, 1vh) * 100) - var(--mobile-header-height));
         }

        @media (min-width: 769px) {
             .main-container {
                  /* Adjust for desktop tab height if needed, depends on sticky behavior */
             }
            .page-content {
                padding: 30px 40px; /* Restore desktop padding */
                 height: auto; /* Let content determine height */
            }
             #agent-page {
                 padding: 30px 40px; /* Restore padding */
                 height: auto;
             }
        }


        .chat-section-container {
            flex: 1; /* Takes full width on mobile */
            display: flex;
            flex-direction: column; /* Stack vertically */
            background: transparent; /* Remove container background for mobile */
            border-radius: 0;
            border: none;
            backdrop-filter: none;
            padding: 0; /* Remove padding */
            max-height: none; /* Allow full height */
            box-shadow: none;
            height: 100%; /* Ensure it fills parent */
        }
        @media (min-width: 769px) {
             .chat-section-container {
                 flex: 2;
                 flex-direction: row; /* Side-by-side on desktop */
                 gap: 30px;
                 background: var(--container-bg);
                 border-radius: 20px;
                 border: 1px solid var(--border-color);
                 backdrop-filter: blur(20px);
                 padding: 25px;
                 max-height: 80vh;
                 box-shadow: var(--shadow-lg);
                 height: auto; /* Reset height */
             }
        }


        .persona-display { display: none; } /* Hide persona side block */
        @media (min-width: 769px) {
             .persona-display {
                 display: flex; /* Show on desktop */
                 flex: 0 0 200px;
                 text-align: center;
                 flex-direction: column;
                 gap: 12px;
             }
        }


        #mainPersonaImage { width: 100%; border-radius: 20px; border: 3px solid var(--border-color); aspect-ratio: 1 / 1.1; object-fit: cover; box-shadow: 0 8px 30px rgba(0, 169, 157, 0.3); transition: all 0.3s; }
        #mainPersonaImage:hover { transform: scale(1.05); box-shadow: 0 12px 40px rgba(0, 169, 157, 0.5); border-color: var(--primary-blue); }
        .persona-info { margin-top: 0; }
        #mainPersonaName { margin: 0; font-size: 1.2rem; font-weight: 700; color: var(--text-dark); text-shadow: 0 2px 10px rgba(0, 169, 157, 0.2); }
        .persona-info p { margin: 5px 0 0; color: var(--primary-blue); font-weight: 500; font-size: 0.85rem; opacity: 0.9; }
        .quick-actions { display: flex; flex-direction: column; gap: 6px; padding-top: 15px; border-top: 1px solid var(--border-color); }
        .quick-actions h4 { margin: 0 0 8px 0; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.2px; opacity: 0.7; font-weight: 600; text-align: center; color: var(--text-light); }
        .quick-action-btn { background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 10px 12px; border-radius: 10px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s; display: flex; align-items: center; gap: 8px; text-align: left; font-family: 'Poppins', sans-serif; font-weight: 500; }
        .quick-action-btn:hover { background: linear-gradient(135deg, var(--primary-blue), #008a7e); color: var(--text-dark); transform: translateX(5px); box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4); border-color: transparent; }
        .quick-action-btn i { font-size: 1rem; width: 18px; text-align: center; flex-shrink: 0; opacity: 0.9; }
        .quick-action-btn:hover i { opacity: 1; }
        .quick-action-btn span { flex: 1; }

        .chat-interaction-area {
             flex: 1; /* Take remaining space */
             display: flex;
             flex-direction: column;
             min-width: 0;
             height: 100%; /* Full height of parent */
             overflow: hidden; /* Prevent this area from scrolling */
        }
        .chat-messages {
            flex-grow: 1; /* Allow messages to take up space */
            overflow-y: auto; /* Enable scrolling for messages */
            padding: 10px; /* Add padding for mobile */
             /* padding-bottom accounts for sticky footer height */
             padding-bottom: calc(var(--mobile-footer-height) + 20px); /* Increased bottom padding */
        }
        @media (min-width: 769px) {
             .chat-messages {
                 padding: 0 10px 0 0; /* Restore desktop padding */
                 padding-bottom: 10px; /* Remove footer adjustment */
             }
        }

        /* Message Bubble Base Styles */
        .message-bubble { display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-start; animation: slideIn 0.3s ease-out; max-width: 90%; /* Limit width */ }
        .message-bubble.user { justify-content: flex-end; margin-left: auto; /* Push user bubble right */}
        .message-bubble.agent { margin-right: auto; /* Push agent bubble left */ }
        .message-bubble .avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; border: 1px solid var(--border-color); }
        .message-bubble .content { padding: 10px 15px; border-radius: 18px; font-size: 0.95rem; line-height: 1.6; word-break: break-word; }

        /* Desktop Bubble Styles */
        @media (min-width: 769px) {
            .message-bubble { gap: 15px; margin-bottom: 20px; max-width: 85%; }
            .message-bubble .avatar { width: 40px; height: 40px; border-width: 2px; }
            .message-bubble .content { padding: 14px 20px; line-height: 1.7; }
            .message-bubble.user .content { background: linear-gradient(135deg, var(--primary-blue), #008a7e); color: #fff; border-bottom-right-radius: 5px; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15); }
            .message-bubble.agent .content { background-color: rgba(0, 0, 0, 0.25); border: 1px solid var(--border-color); color: var(--text-light); border-bottom-left-radius: 5px; backdrop-filter: blur(10px); box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15); }
        }

        /* Mobile Chat Appearance Override */
        @media (max-width: 768px) {
            .message-bubble { animation: none; max-width: 100%;}
            /* User bubble - keep as is */
            .message-bubble.user .content {
                background: linear-gradient(135deg, var(--primary-blue), #008a7e);
                color: #fff;
                border-bottom-right-radius: 5px;
                box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                border-bottom-left-radius: 18px;
                border-top-left-radius: 18px;
                border-top-right-radius: 18px;
            }
             /* Agent message - enhance slightly */
            .message-bubble.agent {
                 padding-left: 5px; /* Indent agent messages slightly */
            }
            .message-bubble.agent .content {
                background: rgba(0, 0, 0, 0.1) !important; /* Subtle background */
                border: none;
                box-shadow: none;
                padding: 10px 15px; /* Add padding back */
                border-radius: 12px; /* Slightly rounded corners */
                backdrop-filter: none;
                color: var(--text-light);
                line-height: 1.6;
                font-size: 0.9rem; /* Match user bubble font size */
                 border-bottom-left-radius: 5px; /* Keep the agent distinctive corner */
            }
            .message-bubble.agent .content .chart-container {
                 background-color: transparent;
                 padding: 0;
                 border: none;
                 margin-top: 10px;
                 max-width: 100%;
            }
            /* Adjust markdown for subtle background */
            .message-bubble.agent .content h1, .message-bubble.agent .content h2, .message-bubble.agent .content h3 { border: none; padding-bottom: 0; }
            .message-bubble.agent .content table { background: none; font-size: 0.85rem; }
            .message-bubble.agent .content th, .message-bubble.agent .content td { padding: 6px 8px;}
            .message-bubble.agent .content th { background: none; color: var(--primary-blue);}
             .message-bubble.agent .content tr:nth-child(even) { background-color: transparent; }
             .message-bubble.agent .content blockquote { padding-left: 10px; border-left-width: 3px;}
             /* Keep code blocks distinct */
             .message-bubble.agent .content pre, .message-bubble.agent .content code { background-color: rgba(0,0,0,0.3);}
        }


        /* Style for canvas container */
        .message-bubble.agent .content .chart-container { width: 100%; max-width: 450px; margin-top: 15px; background-color: rgba(255, 255, 255, 0.05); padding: 15px; border-radius: 8px; border: 1px solid var(--border-color); }
        .message-bubble.agent .content canvas { max-width: 100%; height: auto; }

        /* Styles for rendered Markdown in agent bubbles */
        .message-bubble.agent .content h1, .message-bubble.agent .content h2, .message-bubble.agent .content h3 { color: var(--primary-blue); margin-top: 1em; margin-bottom: 0.5em; border-bottom: 1px solid var(--border-color); padding-bottom: 4px; }
        .message-bubble.agent .content h4 { color: var(--text-dark); margin-top: 1em; margin-bottom: 0.5em; }
        .message-bubble.agent .content p { margin-top: 0.5em; margin-bottom: 0.5em; }
        .message-bubble.agent .content ul, .message-bubble.agent .content ol { padding-left: 20px; margin: 0.5em 0; }
        .message-bubble.agent .content li { margin-bottom: 0.5em; }
        .message-bubble.agent .content hr { border: none; border-top: 1px solid var(--border-color); margin: 1em 0; }
        .message-bubble.agent .content strong { color: var(--text-dark); }
        .message-bubble.agent .content code { background-color: rgba(0, 0, 0, 0.3); padding: 2px 5px; border-radius: 4px; font-family: monospace; }
        .message-bubble.agent .content pre { background-color: rgba(0, 0, 0, 0.3); padding: 10px; border-radius: 8px; overflow-x: auto; }
        .message-bubble.agent .content pre code { background-color: transparent; padding: 0; }
        .message-bubble.agent .content a { color: var(--primary-blue); text-decoration: none; font-weight: 500; }
        .message-bubble.agent .content a:hover { text-decoration: underline; }
        .message-bubble.agent .content blockquote { border-left: 4px solid var(--primary-blue); padding-left: 15px; margin-left: 0; font-style: italic; color: var(--text-light); opacity: 0.9; }
         /* Markdown table styling */
        .message-bubble.agent .content table { width: auto; max-width: 100%; border-collapse: collapse; margin: 1em 0; font-size: 0.9em; background-color: rgba(0,0,0,0.1); }
        .message-bubble.agent .content th, .message-bubble.agent .content td { border: 1px solid var(--border-color); padding: 8px 12px; text-align: left; }
        .message-bubble.agent .content th { background-color: rgba(0, 169, 157, 0.2); color: var(--text-dark); font-weight: 600; }
        .message-bubble.agent .content tr:nth-child(even) { background-color: rgba(255,255,255,0.05); }

        .chat-input-area {
            display: flex;
            align-items: center;
            gap: 10px; /* Reduced gap */
            padding: 10px 15px; /* Base padding */
            padding-bottom: calc(10px + env(safe-area-inset-bottom)); /* iOS safe area */
            border-top: 1px solid var(--border-color);
            background-color: rgba(0, 40, 45, 0.9); /* Match header */
            backdrop-filter: blur(15px);
            position: sticky; /* Make it sticky */
            bottom: 0; /* Stick to bottom */
            z-index: 1000;
            height: var(--mobile-footer-height); /* Use variable */
             flex-shrink: 0; /* Prevent footer shrinking */
        }
        @media (min-width: 769px) {
            .chat-input-area {
                 position: static; /* Not sticky on desktop */
                 border-radius: 0 0 20px 0; /* Restore desktop corner */
                 padding: 20px 25px;
                 gap: 15px;
                 height: auto;
                  margin: 0 -25px -25px -25px; /* Restore desktop margin */
            }
        }

        .chat-input-controls { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        #chatInput {
            flex: 1;
            min-width: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.1); /* Slight background */
            border: 1px solid var(--border-color);
            outline: none;
            color: var(--text-dark);
            font-size: 1rem;
            padding: 10px 15px; /* Padding inside input */
            border-radius: 20px; /* Rounded input */
            font-family: 'Poppins', sans-serif;
        }
        #chatInput::placeholder { color: var(--text-light); opacity: 0.6; }
        .chat-input-controls button {
            background: transparent; /* Transparent background */
            border: none; /* No border */
            color: var(--text-light);
            font-size: 1.3rem; /* Larger icons */
            cursor: pointer;
            transition: all 0.2s;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .chat-input-controls button:hover {
            color: var(--primary-blue);
            background: rgba(255, 255, 255, 0.1); /* Slight hover effect */
            transform: none; /* Remove scale */
        }
        .send-btn {
            background: var(--primary-blue) !important; /* Solid color */
            color: white !important;
            box-shadow: none; /* Remove gradient shadow */
        }
        .send-btn:hover {
             background: #008a7e !important; /* Darker hover */
             box-shadow: none !important;
             transform: none !important;
        }
        /* Hide + and persona buttons on desktop input */
        @media (min-width: 769px) {
             #chat-action-btn, #changePersonaBtn { display: flex; } /* Ensure they show if needed */
             /* Re-apply desktop input styles if different */
              #chatInput { background: transparent; border: none; padding: 12px 0; border-radius: 0;}
             .chat-input-controls button { background: rgba(255, 255, 255, 0.1); border: 1px solid var(--border-color); font-size: 1.1rem; }
             .chat-input-controls button:hover { color: var(--text-dark); background: var(--primary-blue); border-color: var(--primary-blue); transform: scale(1.1); }
             .send-btn { background: linear-gradient(135deg, var(--primary-blue), #008a7e) !important; border: none !important; box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4); }
             .send-btn:hover { box-shadow: 0 6px 20px rgba(0, 169, 157, 0.6) !important; transform: scale(1.1) !important; }
        }


        .summary-section { display: none; } /* Hide summary on mobile */
        @media (min-width: 769px) {
             .summary-section { display: flex; /* Show on desktop */}
        }
        .summary-header { display: flex; justify-content: space-between; align-items: center; }
        .summary-header h3 { margin: 0; font-size: 1.3rem; color: var(--text-dark); font-weight: 600; }
        .summary-header button { background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 10px 18px; border-radius: 10px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .summary-header button:hover { background: linear-gradient(135deg, var(--primary-blue), #008a7e); color: #fff; border-color: var(--primary-blue); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4); }
        .summary-content { font-size: 0.95rem; line-height: 1.7; color: var(--text-light); overflow-y: auto; flex: 1; }
        .summary-content h4 { color: var(--primary-blue); margin-top: 20px; margin-bottom: 12px; font-weight: 600; border-bottom: 2px solid var(--border-color); padding-bottom: 8px; font-size: 1.1rem; text-shadow: 0 2px 10px rgba(0, 169, 157, 0.2); }
        .summary-content h4:first-child { margin-top: 0; }
        .summary-content ul { list-style-type: none; padding-left: 15px; margin-top: 10px; }
        .summary-content ul li { position: relative; padding-left: 20px; margin-bottom: 8px; }
        .summary-content ul li::before { content: '▶'; position: absolute; left: 0; top: 0; color: var(--primary-blue); font-size: 0.8em; }
        .summary-content ul li strong { color: var(--text-dark); }
        .key-topics-pills { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px; }
        .key-topic-pill { background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 5px 12px; border-radius: 15px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .key-topic-pill:hover { background: var(--primary-blue); color: var(--text-dark); border-color: var(--primary-blue); }

        .typing-indicator { display: flex; align-items: center; }
        .typing-indicator span { height: 8px; width: 8px; margin: 0 2px; background-color: var(--primary-blue); border-radius: 50%; display: inline-block; animation: bounce 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        /* Other Pages - Placeholder, Tools, Agenda containers */
        .placeholder-page, .agenda-container { flex: 1; background: var(--container-bg); border-radius: 20px; border: 1px solid var(--border-color); backdrop-filter: blur(20px); padding: 25px; display: flex; flex-direction: column; gap: 15px; min-width: 300px; max-height: 80vh; box-shadow: var(--shadow-lg); overflow: hidden; }
        .placeholder-page h2 { color: var(--primary-blue); text-align: center; }
        .placeholder-page p { text-align: center; font-size: 1.1rem; }
        /* Style for AI Tools Cards */
        #tools-page { flex-direction: column; align-items: center;}
        .tools-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; width: 100%; padding: 20px 0; }
        .tool-card { background: var(--container-bg); border-radius: 15px; border: 1px solid var(--border-color); padding: 25px; display: flex; flex-direction: column; align-items: center; text-align: center; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: var(--shadow-sm); backdrop-filter: blur(15px); }
        .tool-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-md); border-color: var(--primary-blue); background: linear-gradient(135deg, var(--container-bg), rgba(0, 169, 157, 0.1)); }
        .tool-icon { font-size: 2.2rem; color: var(--primary-blue); margin-bottom: 15px; transition: all 0.3s; }
        .tool-card:hover .tool-icon { transform: scale(1.1); text-shadow: 0 2px 15px rgba(0, 169, 157, 0.4); }
        .tool-title { color: var(--text-dark); margin: 0 0 10px 0; font-size: 1.1rem; font-weight: 600; }
        .tool-description { font-size: 0.85rem; line-height: 1.6; opacity: 0.85; flex-grow: 1; margin-bottom: 15px; }
        .tool-action-btn { background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 0.8rem; transition: all 0.3s; display: inline-flex; align-items: center; gap: 6px; margin-top: auto; }
        .tool-action-btn:hover { background: linear-gradient(135deg, var(--primary-blue), #008a7e); color: var(--text-dark); transform: translateY(-2px); box-shadow: 0 3px 10px rgba(0, 169, 157, 0.3); border-color: transparent; }


        .agenda-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 20px; border-bottom: 2px solid var(--border-color); margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .agenda-header h2 { margin: 0; font-weight: 600; font-size: 1.5rem; color: var(--text-dark); text-shadow: 0 2px 10px rgba(0, 169, 157, 0.2); flex: 1 1 auto; min-width: 150px; }
        .view-toggle { display: flex; gap: 5px; background: var(--container-bg-light); padding: 4px; border-radius: 25px; border: 1px solid var(--border-color); }
        .view-toggle button, .mobile-view-btn { background: transparent; border: none; color: var(--text-light); padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 0.9rem; transition: all 0.3s; font-weight: 500; }
        .view-toggle button.active, .mobile-view-btn.active { background: linear-gradient(135deg, var(--primary-blue), #008a7e); color: var(--text-dark); box-shadow: 0 2px 10px rgba(0, 169, 157, 0.4); }
        .view-toggle button:hover:not(.active), .mobile-view-btn:hover:not(.active) { background: rgba(255, 255, 255, 0.1); }
        .agenda-view { display: none; flex-grow: 1; min-height: 0; overflow-y: auto; }
        .agenda-view.active { display: block; }
        #today-view.active, #week-view.active { display: flex !important; flex-direction: column; gap: 15px; }
        #month-view.active { display: flex !important; flex-direction: column; }
        .month-calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; margin-top: 15px; flex-grow: 1; min-height: 0; grid-template-rows: auto repeat(6, 1fr); }
        .month-day-header { text-align: center; font-weight: 600; font-size: 0.85rem; opacity: 0.7; padding: 10px 5px; text-transform: uppercase; letter-spacing: 1px; }
        .month-day-header.weekend { background-color: rgba(0, 0, 0, 0.15); border-radius: 5px 5px 0 0; }
        .month-day-cell { border: 1px solid var(--border-color); border-radius: 10px; padding: 8px; background: var(--container-bg-light); cursor: pointer; transition: all 0.3s; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        .month-day-cell:hover { background: rgba(0, 169, 157, 0.2); transform: scale(1.02); border-color: var(--primary-blue); }
        .month-day-cell.weekend { background-color: rgba(0, 0, 0, 0.15); }
        .month-day-cell.today { border: 2px solid var(--primary-blue); background: rgba(0, 169, 157, 0.15); box-shadow: 0 0 15px rgba(0, 169, 157, 0.3); }
        .month-day-cell.other-month, .month-day-cell.disabled-day { opacity: 0.3; pointer-events: none; background: transparent; }
        .month-day-number { font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; flex-shrink: 0; }
        .month-day-events { display: flex; flex-direction: column; gap: 3px; flex-grow: 1; overflow: hidden; }
        .month-event-dot { width: 100%; height: 4px; background: var(--primary-blue); border-radius: 2px; font-size: 0.7rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .month-event-dot.milestone { background: #ffc107; }
        .today-header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; }
        .today-date { font-size: 1.2rem; font-weight: 600; color: var(--text-dark); }
        .today-events-list { display: flex; flex-direction: column; gap: 12px; }
        .desktop-calendar { display: block; }
        .mobile-calendar { display: none; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; flex: 1; }
        .day-column { border-right: 1px solid var(--border-color); padding: 5px; }
        .day-column:last-child { border-right: none; }
        .day-column.weekend { background-color: rgba(0, 0, 0, 0.2); border-radius: 5px; }
        .day-header { text-align: center; font-weight: 600; padding-bottom: 8px; margin-bottom: 15px; border-bottom: 2px solid var(--border-color); }
        .day-header .day-name { font-size: 0.75em; opacity: 0.7; text-transform: uppercase; letter-spacing: 1px; }
        .day-header .day-number { font-size: 1.4em; margin-top: 5px; color: var(--text-dark); font-weight: 700; }
        .event { background: linear-gradient(135deg, rgba(0, 169, 157, 0.15), rgba(0, 169, 157, 0.25)); border-left: 4px solid var(--primary-blue); padding: 12px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        .event:hover { background: linear-gradient(135deg, rgba(0, 169, 157, 0.3), rgba(0, 169, 157, 0.4)); transform: translateX(5px); box-shadow: 0 4px 15px rgba(0, 169, 157, 0.3); }
        .event-time { font-size: 0.8em; opacity: 0.9; margin-bottom: 5px; font-weight: 500; }
        .event-title { font-weight: 600; color: var(--text-dark); font-size: 0.95rem; }
        .event-milestone { background: linear-gradient(135deg, rgba(255, 193, 7, 0.15), rgba(255, 193, 7, 0.25)); border-left-color: #ffc107; }
        .event-milestone:hover { background: linear-gradient(135deg, rgba(255, 193, 7, 0.3), rgba(255, 193, 7, 0.4)); }

        .topics-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; width: 100%; }
        .topic-card { background: var(--container-bg); border-radius: 20px; border: 1px solid var(--border-color); padding: 25px; display: flex; flex-direction: column; justify-content: space-between; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: var(--shadow-md); backdrop-filter: blur(20px); }
        .topic-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 15px 40px rgba(0, 169, 157, 0.3); border-color: var(--primary-blue); background: linear-gradient(135deg, var(--container-bg), rgba(0, 169, 157, 0.1)); }
        .topic-icon { font-size: 2.5rem; color: var(--primary-blue); margin-bottom: 15px; transition: all 0.3s; }
        .topic-card:hover .topic-icon { transform: scale(1.1) rotate(5deg); text-shadow: 0 4px 20px rgba(0, 169, 157, 0.5); }
        .topic-title { color: var(--text-dark); margin: 0 0 10px 0; font-size: 1.3rem; font-weight: 600; }
        .topic-description { font-size: 0.9rem; line-height: 1.7; margin-bottom: 20px; flex-grow: 1; opacity: 0.9; }
        .topic-kpis { display: flex; gap: 25px; margin-bottom: 20px; padding: 20px 0; border-top: 1px solid var(--border-color); border-bottom: 1px solid var(--border-color); }
        .kpi-item { text-align: center; flex: 1; }
        .kpi-value { display: block; font-size: 2rem; font-weight: 700; color: var(--primary-blue); text-shadow: 0 2px 10px rgba(0, 169, 157, 0.3); }
        .kpi-label { font-size: 0.75rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 0.5px; }
        .topic-actions { display: flex; gap: 10px; padding-top: 15px; }
        .topic-actions button { flex: 1; background: rgba(0, 0, 0, 0.2); border: 1px solid var(--border-color); color: var(--text-light); padding: 10px 12px; border-radius: 10px; cursor: pointer; font-size: 0.85rem; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .topic-actions button:hover { background: linear-gradient(135deg, var(--primary-blue), #008a7e); color: var(--text-dark); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4); border-color: transparent; }

        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); backdrop-filter: blur(5px); justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .modal-content { background: var(--container-bg); border: 1px solid var(--border-color); backdrop-filter: blur(30px); padding: 35px; border-radius: 20px; width: 650px; max-width: 90%; text-align: left; position: relative; animation: slideInModal 0.4s cubic-bezier(0.4, 0, 0.2, 1); max-height: 80vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        @keyframes slideInModal { from { transform: translateY(-50px) scale(0.9); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .close-button { color: #aaa; position: absolute; top: 15px; right: 25px; font-size: 32px; font-weight: bold; cursor: pointer; transition: all 0.3s; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }
        .close-button:hover { color: #fff; background: rgba(255, 255, 255, 0.1); transform: rotate(90deg); }
        .modal-content h2 { margin-top: 0; color: var(--primary-blue); margin-bottom: 25px; text-align: center; font-size: 1.5rem; text-shadow: 0 2px 10px rgba(0, 169, 157, 0.3); }
        #event-modal-title { font-size: 1.5rem; color: var(--text-dark); margin: 0 0 5px 0; text-align: left; }
        #event-modal-time { color: var(--primary-blue); font-weight: 500; margin-bottom: 15px; text-align: left; }
        #event-modal-details { margin-bottom: 20px; line-height: 1.6; text-align: left;}
        .event-actions, .day-actions { display: flex; flex-direction: column; gap: 12px; border-top: 1px solid var(--border-color); padding-top: 20px; margin-top: 10px; }
        .event-actions button, .day-actions button { flex: 1; background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 12px 20px; border-radius: 12px; cursor: pointer; font-size: 0.95rem; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px; font-weight: 500; }
        .event-actions button:hover, .day-actions button:hover { background: linear-gradient(135deg, var(--primary-blue), #008a7e); color: var(--text-dark); border-color: transparent; transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4); }

        /* Persona Modal Specific Styles */
        #personaModal .modal-content { width: 500px; /* Adjust width */ }
        .persona-options { display: flex; flex-direction: column; gap: 10px; /* Reduced gap */ }
        .persona-option { flex-direction: row; gap: 15px; padding: 15px; }
        .persona-option img { width: 60px; height: 60px; /* Slightly smaller images */ }
        .persona-details h4 { font-size: 1.05rem; }
        .persona-details p { font-size: 0.85rem; }
        @media (max-width: 768px) {
             #personaModal .modal-content { width: 90%; }
             /* Ensure 3 personas fit without scrolling if possible */
             .persona-options { gap: 8px;}
             .persona-option { padding: 12px; gap: 10px; }
             .persona-option img { width: 45px; height: 45px; }
             .persona-details h4 { font-size: 1rem; margin-bottom: 4px;}
             .persona-details p { font-size: 0.8rem; line-height: 1.4; }

        }


        .key-topic-pill, .modal-topic-pill { background: var(--container-bg-light); border: 1px solid var(--border-color); color: var(--text-light); padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; display: inline-flex; align-items: center; gap: 5px; }
        .key-topic-pill:hover, .modal-topic-pill:hover, .modal-topic-pill.active { background: linear-gradient(135deg, var(--primary-blue), #008a7e); color: var(--text-dark); border-color: var(--primary-blue); transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 169, 157, 0.4); }
        .modal-pills-container { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px 0; }
        #meetings-modal-list .meeting-item { cursor: pointer; transition: all 0.3s; background: var(--container-bg-light); padding: 18px; border-radius: 12px; margin-bottom: 12px; border-left: 4px solid var(--primary-blue); box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); }
        #meetings-modal-list .meeting-item:hover { background: linear-gradient(135deg, rgba(0, 169, 157, 0.15), rgba(0, 169, 157, 0.25)); transform: translateX(5px); box-shadow: 0 4px 15px rgba(0, 169, 157, 0.3); }
        #meetings-modal-list .meeting-title { font-weight: 600; color: var(--text-dark); font-size: 1.05rem; margin-bottom: 5px; }
        #meetings-modal-list .meeting-time { font-size: 0.9em; opacity: 0.8; color: var(--primary-blue); }
        #meetings-modal-list .dropdown-header, #dayActionModal .dropdown-header { font-size: 0.85rem; text-transform: uppercase; opacity: 0.7; padding: 20px 0 10px; border-bottom: 1px solid var(--border-color); margin-bottom: 15px; font-weight: 600; letter-spacing: 1px; }

        #ask-agent-btn { position: absolute; display: none; background: var(--container-bg); backdrop-filter: blur(15px); border: 1px solid var(--primary-blue); color: var(--text-light); padding: 10px 16px; border-radius: 25px; cursor: pointer; font-size: 0.9rem; z-index: 1001; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(0, 169, 157, 0.4); font-weight: 500; }
        #ask-agent-btn:hover { background: linear-gradient(135deg, var(--primary-blue), #008a7e); color: var(--text-dark); transform: translateY(-2px); box-shadow: 0 6px 25px rgba(0, 169, 157, 0.6); }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(0, 0, 0, 0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: var(--primary-blue); border-radius: 10px; transition: background 0.3s; }
        ::-webkit-scrollbar-thumb:hover { background: #008a7e; }

         /* Mobile Overrides - Final Pass */
         @media (max-width: 768px) {
             /* Ensure full height layout */
             html, body { height: 100%; overflow: hidden; }
             body { height: calc(var(--vh, 1vh) * 100); }
             .main-container { height: calc(100% - var(--mobile-header-height)); } /* Height minus header */
             .page-content { height: 100%; } /* Fill main container */
              #agent-page { height: 100%; } /* Agent page fills container */
              .chat-section-container { height: 100%; } /* Chat container fills agent page */

             /* Non-agent pages scrolling */
             #topics-page, #agenda-page, #tools-page, #compose-page, #templates-page {
                 overflow-y: auto;
                 padding: 15px; /* Add back padding for these pages */
                 height: 100%; /* Ensure they take full height for scrolling */
             }
             .topics-container, .tools-container { padding: 0; } /* Remove extra padding inside */
             .agenda-container {
                 padding: 10px; /* Restore padding */
                 height: 100%;
                 overflow-y: auto; /* Allow agenda container itself to scroll if needed */
             }
             .placeholder-page { padding: 30px 15px; }

         }


    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
             <button class="mobile-menu-btn"><i class="fas fa-bars"></i></button>
            <img src="https://www.hrsd.gov.sa/assets/logo.svg" alt="HRSD Logo" class="hrsd-logo">
            <span>| AI Executive Office</span>
        </div>
        <div class="header-right">
            <div class="user-profile">
                <span class="welcome-text">Welcome Ahmad</span>
                <img src="https://placehold.co/40x40/28a745/ffffff?text=A" alt="User Avatar">
            </div>
             <button id="newChatBtn" title="New Chat / Change Persona"><i class="fas fa-edit"></i></button>
             <!-- Hamburger button moved to header-left for mobile view -->
        </div>
    </header>

    <!-- Mobile Navigation Overlay -->
    <div class="mobile-nav-overlay" id="mobileNav">
         <ul class="mobile-nav-menu">
            <li><a href="#" class="nav-link active" data-target="agent-page"><i class="fas fa-robot"></i> AEO Agent</a></li>
            <li><a href="#" class="nav-link" data-target="topics-page"><i class="fas fa-th-large"></i> Focus Areas</a></li>
            <li><a href="#" class="nav-link" data-target="agenda-page"><i class="fas fa-calendar-alt"></i> Agenda</a></li>
            <li><a href="#" class="nav-link" data-target="tools-page"><i class="fas fa-cogs"></i> AI Tools</a></li>
            <li><a href="#" class="nav-link" data-target="compose-page"><i class="fas fa-pen-alt"></i> Compose</a></li>
            <li><a href="#" class="nav-link" data-target="templates-page"><i class="fas fa-file-alt"></i> Templates</a></li>
         </ul>
    </div>
    <div class="nav-backdrop" id="navBackdrop"></div>


    <!-- Desktop Navigation Tabs -->
    <div class="nav-tabs-container">
        <nav class="nav-tabs">
            <button class="nav-button active" data-target="agent-page"><i class="fas fa-robot"></i> AEO Agent</button>
            <button class="nav-button" data-target="topics-page"><i class="fas fa-th-large"></i> Focus Areas</button>
            <button class="nav-button" data-target="agenda-page"><i class="fas fa-calendar-alt"></i> Agenda</button>
            <button class="nav-button" data-target="tools-page"><i class="fas fa-cogs"></i> AI Tools</button>
            <button class="nav-button" data-target="compose-page"><i class="fas fa-pen-alt"></i> Compose</button>
            <button class="nav-button" data-target="templates-page"><i class="fas fa-file-alt"></i> Templates</button>
        </nav>
    </div>

    <!-- Main Content Container -->
    <div class="main-container">
        <!-- Agent Chat Page -->
        <main id="agent-page" class="page-content active">
            <section class="chat-section-container">
                <!-- Persona Display (Desktop Only) -->
                <div class="persona-display">
                    <img id="mainPersonaImage" src="https://hams.ai/images/ai-voice-agent.png" alt="AI Persona">
                    <div class="persona-info">
                        <h3 id="mainPersonaName">Hakim Nüruddin</h3>
                        <p id="mainPersonaTitle">AI Executive Office Agent</p>
                    </div>
                    <div class="quick-actions">
                        <h4>Quick Actions</h4>
                        <button class="quick-action-btn" data-action="call">
                            <i class="fas fa-phone"></i>
                            <span>Call Agent</span>
                        </button>
                        <button class="quick-action-btn" data-action="agenda">
                            <i class="fas fa-calendar-day"></i>
                            <span>Today's Agenda</span>
                        </button>
                    </div>
                </div>
                <!-- Chat Interaction Area -->
                <div class="chat-interaction-area">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Initial Greeting -->
                        <div class="message-bubble agent">
                            <img src="https://hams.ai/images/ai-voice-agent.png" alt="Agent Avatar" class="avatar" data-persona-avatar>
                            <div class="content">Welcome your Highness. As-salāmu 'alaykum. I am Hakim, your AI Executive Office Agent. How may I assist you today?</div>
                        </div>
                    </div>
                    <!-- Sticky Chat Input Area -->
                    <div class="chat-input-area">
                        <button id="chat-action-btn" title="Discuss a Topic"><i class="fas fa-plus"></i></button>
                        <input id="chatInput" type="text" placeholder="Ask anything...">
                        <div class="chat-input-controls">
                             <!-- <button id="voiceInputBtn" title="Voice Input"><i class="fas fa-microphone"></i></button> -->
                             <!-- Persona button hidden on mobile input, moved to header -->
                             <button id="send-btn" class="send-btn" title="Send Message"><i class="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Summary Section (Desktop Only) -->
            <section class="summary-section">
                <div class="summary-header">
                    <h3>Today's Agenda</h3>
                    <button id="copy-summary-btn"><i class="fas fa-copy" style="margin-right: 5px;"></i>Copy</button>
                </div>
                <div class="summary-content" id="summary-content">
                    <!-- Content populated by JS -->
                </div>
            </section>
        </main>

        <!-- Focus Areas Page -->
        <div id="topics-page" class="page-content">
            <div class="topics-container" style="width: 100%;">
                <!-- Topic Card 1 -->
                <div class="topic-card" data-topic-id="labor-market">
                    <div class="topic-icon"><i class="fas fa-briefcase"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Strengthening Labor Market</h3>
                        <p class="topic-description">Developing policies to create an attractive, inclusive, and safe labor market that empowers Saudi nationals and aligns with global standards.</p>
                    </div>
                    <div class="topic-kpis">
                        <div class="kpi-item">
                            <span class="kpi-value">4</span>
                            <span class="kpi-label">Strategic KPIs</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-value">7</span>
                            <span class="kpi-label">Related Initiatives</span>
                        </div>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                    </div>
                </div>
                <!-- Topic Card 2 -->
                <div class="topic-card" data-topic-id="empowerment">
                     <div class="topic-icon"><i class="fas fa-users"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Empowering Society & Individuals</h3>
                        <p class="topic-description">Enhancing social development, empowering individuals and communities, and promoting self-reliance through targeted programs and support.</p>
                    </div>
                     <div class="topic-kpis">
                        <div class="kpi-item">
                            <span class="kpi-value">5</span>
                            <span class="kpi-label">Strategic KPIs</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-value">9</span>
                            <span class="kpi-label">Related Initiatives</span>
                        </div>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                    </div>
                </div>
                <!-- Topic Card 3 -->
                <div class="topic-card" data-topic-id="non-profit">
                     <div class="topic-icon"><i class="fas fa-hand-holding-heart"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Enabling the Non-Profit Sector</h3>
                        <p class="topic-description">Fostering the growth and impact of the non-profit sector to expand its contribution to the economy and social development.</p>
                    </div>
                     <div class="topic-kpis">
                        <div class="kpi-item">
                            <span class="kpi-value">3</span>
                            <span class="kpi-label">Strategic KPIs</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-value">4</span>
                            <span class="kpi-label">Related Initiatives</span>
                        </div>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                    </div>
                </div>
                <!-- Topic Card 4 -->
                <div class="topic-card" data-topic-id="strategic-partnerships">
                     <div class="topic-icon"><i class="fas fa-handshake"></i></div>
                    <div class="topic-content">
                        <h3 class="topic-title">Strategic Partnerships</h3>
                        <p class="topic-description">Building effective and sustainable partnerships with public, private, and non-profit entities to achieve shared national goals.</p>
                    </div>
                     <div class="topic-kpis">
                        <div class="kpi-item">
                            <span class="kpi-value">2</span>
                            <span class="kpi-label">Strategic KPIs</span>
                        </div>
                        <div class="kpi-item">
                            <span class="kpi-value">6</span>
                            <span class="kpi-label">Related Initiatives</span>
                        </div>
                    </div>
                    <div class="topic-actions">
                        <button class="topic-action-btn" data-action="meetings"><i class="fas fa-calendar-days"></i> Related Meetings</button>
                        <button class="topic-action-btn" data-action="deeper"><i class="fas fa-magnifying-glass"></i> Dig Deeper</button>
                        <button class="topic-action-btn" data-action="references"><i class="fas fa-file-alt"></i> View References</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agenda Page -->
        <div id="agenda-page" class="page-content">
            <div class="agenda-container" style="width: 100%;">
                <!-- Desktop Calendar View -->
                <div class="desktop-calendar">
                    <div class="agenda-header">
                        <h2>October 2025</h2>
                        <div class="view-toggle">
                            <button class="view-btn" data-view="today">Today</button>
                            <button class="view-btn active" data-view="week">Week</button>
                            <button class="view-btn" data-view="month">Month</button>
                        </div>
                    </div>

                    <!-- Today View (Desktop) -->
                    <div id="today-view" class="agenda-view">
                        <div class="today-header">
                            <div class="today-date">Monday, October 20, 2025</div>
                        </div>
                        <div class="today-events-list" id="today-events-list">
                            <!-- Events will be populated by JavaScript -->
                        </div>
                    </div>

                    <!-- Week View (Desktop) -->
                    <div id="week-view" class="agenda-view active">
                        <div class="calendar-grid">
                            <div class="day-column"><div class="day-header"><div class="day-name">Sun</div><div class="day-number">19</div></div></div>
                            <div class="day-column"><div class="day-header"><div class="day-name">Mon</div><div class="day-number">20</div></div> <div class="event" data-event-title="Labor Market Policy Review" data-event-time="09:00 AM" data-event-details="Strategic sync on new labor market policies to enhance Saudization." data-topic="labor-market" data-date="2025-10-20"> <div class="event-time">09:00 AM</div> <div class="event-title">Labor Market Policy Review</div> </div> <div class="event event-milestone" data-event-title="Milestone: Non-Profit Portal Launch" data-event-time="EOD" data-event-details="Official launch of the new national portal for non-profit organizations. Review launch communications." data-topic="non-profit" data-date="2025-10-20"> <div class="event-time">EOD</div> <div class="event-title">Milestone: Non-Profit Portal Launch</div> </div></div>
                            <div class="day-column"><div class="day-header"><div class="day-name">Tue</div><div class="day-number">21</div></div> <div class="event" data-event-title="Partnership MoU Signing" data-event-time="10:00 AM" data-event-details="Ceremony for signing the Memorandum of Understanding with key private sector partners." data-topic="strategic-partnerships" data-date="2025-10-21"> <div class="event-time">10:00 AM</div> <div class="event-title">Partnership MoU Signing</div> </div></div>
                            <div class="day-column"><div class="day-header"><div class="day-name">Wed</div><div class="day-number">22</div></div></div>
                            <div class="day-column"><div class="day-header"><div class="day-name">Thu</div><div class="day-number">23</div></div> <div class="event" data-event-title="Community Empowerment Briefing" data-event-time="02:00 PM" data-event-details="Briefing on the results of the recent community empowerment programs and future plans." data-topic="empowerment" data-date="2025-10-23"> <div class="event-time">02:00 PM</div> <div class="event-title">Community Empowerment Briefing</div> </div></div>
                            <div class="day-column weekend"><div class="day-header"><div class="day-name">Fri</div><div class="day-number">24</div></div></div>
                            <div class="day-column weekend"><div class="day-header"><div class="day-name">Sat</div><div class="day-number">25</div></div></div>
                        </div>
                    </div>

                    <!-- Month View (Desktop) -->
                    <div id="month-view" class="agenda-view">
                        <div class="month-calendar-grid" id="month-calendar-grid">
                            <!-- Month calendar will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
                <!-- Mobile Calendar View -->
                <div class="mobile-calendar">
                     <div class="agenda-header">
                        <h2 id="mobile-calendar-title">October 2025</h2>
                        <div class="view-toggle">
                            <button class="mobile-view-btn" data-view="today">Today</button>
                            <button class="mobile-view-btn active" data-view="week">Week</button>
                            <button class="mobile-view-btn" data-view="month">Month</button>
                        </div>
                    </div>
                    <div id="mobile-month-grid"></div>
                    <div id="mobile-agenda-events"></div>
                </div>
            </div>
        </div>


        <!-- Tools Page -->
        <div id="tools-page" class="page-content">
            <h2 style="color: var(--primary-blue); text-align: center; width: 100%; margin-bottom: 20px;"><i class="fas fa-cogs"></i> Suggested AI Tools</h2>
            <div class="tools-container">
                <!-- Tool Card 1: Data Visualization -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-chart-bar"></i></div>
                    <h3 class="tool-title">AI-Powered Data Visualization</h3>
                    <p class="tool-description">Automatically generates insightful charts and dashboards from ministry data, highlighting key trends, anomalies, and performance metrics without manual setup.</p>
                    <button class="tool-action-btn" data-tool-action="visualize"><i class="fas fa-eye"></i> Explore Tool</button>
                </div>
                <!-- Tool Card 2: Predictive Analytics -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-brain"></i></div>
                    <h3 class="tool-title">Predictive Policy Modeling</h3>
                    <p class="tool-description">Simulates the potential impact of proposed policies on key indicators (e.g., employment, social welfare) using AI to forecast outcomes and risks.</p>
                    <button class="tool-action-btn" data-tool-action="predict"><i class="fas fa-cogs"></i> Run Simulation</button>
                </div>
                <!-- Tool Card 3: Report Generation -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-file-invoice"></i></div>
                    <h3 class="tool-title">Automated Report Synthesis</h3>
                    <p class="tool-description">Condenses lengthy reports, research papers, and meeting transcripts into concise executive summaries, extracting key findings and action items.</p>
                    <button class="tool-action-btn" data-tool-action="summarize"><i class="fas fa-align-left"></i> Generate Summary</button>
                </div>
                 <!-- Tool Card 4: Sentiment Analysis -->
                <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-comments"></i></div>
                    <h3 class="tool-title">Public Sentiment Analysis</h3>
                    <p class="tool-description">Analyzes social media, news, and public feedback channels to gauge sentiment towards HRSD initiatives and identify emerging public concerns.</p>
                    <button class="tool-action-btn" data-tool-action="sentiment"><i class="fas fa-search"></i> View Sentiment</button>
                </div>
                 <!-- Tool Card 5: Smart Scheduling -->
                 <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-calendar-check"></i></div>
                    <h3 class="tool-title">Intelligent Meeting Scheduler</h3>
                    <p class="tool-description">Optimizes scheduling for complex, multi-attendee high-level meetings by considering priorities, availability, and optimal time slots using AI.</p>
                    <button class="tool-action-btn" data-tool-action="schedule"><i class="fas fa-calendar-plus"></i> Schedule Meeting</button>
                </div>
                 <!-- Tool Card 6: Risk Assessment -->
                 <div class="tool-card">
                    <div class="tool-icon"><i class="fas fa-shield-alt"></i></div>
                    <h3 class="tool-title">AI Risk Assessment</h3>
                    <p class="tool-description">Identifies potential risks in projects, policies, or operational areas by analyzing historical data and external factors, providing early warnings.</p>
                    <button class="tool-action-btn" data-tool-action="risk"><i class="fas fa-exclamation-triangle"></i> Assess Risk</button>
                </div>
            </div>
        </div>
        <!-- Placeholder Pages -->
        <div id="compose-page" class="page-content"> <div class="placeholder-page" style="width: 100%;"> <h2><i class="fas fa-pen-alt"></i> Compose</h2> <p>Use this section to draft emails, reports, and other documents with AI assistance. The agent can help with tone, clarity, and content generation.</p> </div> </div>
        <div id="templates-page" class="page-content"> <div class="placeholder-page" style="width: 100%;"> <h2><i class="fas fa-file-alt"></i> Templates</h2> <p>Access a library of pre-built templates for various documents, including meeting minutes, project proposals, and executive summaries, to streamline your workflow.</p> </div> </div>
    </div>

    <!-- Modals -->
    <div id="personaModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2>Choose Your AI Agent</h2>
            <div class="persona-options" id="personaOptions"></div>
        </div>
    </div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h3 id="event-modal-title">Event Title</h3>
            <p id="event-modal-time">Event Time</p>
            <p id="event-modal-details">Event Details</p>
            <div class="event-actions">
                <button id="summarize-event-btn"><i class="fas fa-align-left"></i> Summarize</button>
                <button id="prepare-event-btn"><i class="fas fa-clipboard-check"></i> Consult for Preparation</button>
            </div>
        </div>
    </div>

    <div id="meetingsModal" class="modal">
        <div class="modal-content" id="focus-modal-content">
            <span class="close-button">&times;</span>
            <h2 id="meetings-modal-title">Discuss a Topic</h2>
            <div id="meetings-modal-list"></div>
        </div>
    </div>

    <div id="dayActionModal" class="modal">
        <div class="modal-content">
            <span class="close-button">&times;</span>
            <h2 id="day-action-title">Actions for Date</h2>
            <div id="day-action-focus-areas">
                 <div class="dropdown-header">Select a Focus Area</div>
                 <div class="modal-pills-container" id="day-action-pills">
                     <!-- Pills will be populated by JS -->
                 </div>
            </div>
            <div class="day-actions">
                <button data-action="check"><i class="fas fa-calendar-check"></i> Check Availability</button>
                <button data-action="media"><i class="fas fa-bullhorn"></i> Coordinate with Media Team</button>
                <button data-action="consulting"><i class="fas fa-users-cog"></i> Summon Consulting Team</button>
            </div>
        </div>
    </div>

    <!-- Simple Message Modal (replaces alert) -->
    <div id="messageModal" class="modal">
        <div class="modal-content" style="width: 400px; max-width: 90%;">
            <span class="close-button">&times;</span>
            <h2 id="message-modal-title" style="color: var(--primary-blue); margin-bottom: 15px;">Notice</h2>
            <p id="message-modal-text" style="text-align: center; font-size: 1.1rem; line-height: 1.6;"></p>
        </div>
    </div>

    <!-- Floating "Ask Agent" Button -->
    <div id="ask-agent-btn"><i class="fas fa-comment-dots"></i> Ask Agent</div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DATA ---
            const personaData = [
                { id: 'hakim', name: 'Hakim Nüruddin', title: 'AI Executive Office Agent', largeImg: 'https://hams.ai/images/ai-voice-agent.png', smallImg: 'https://hams.ai/images/ai-voice-agent.png', description: 'As your strategic partner, I provide high-level summaries, executive advice, and focus on strategic alignment for your key decisions.', systemPrompt: 'You are Hakim Nüruddin, an AI Executive Office Agent for HRSD in Saudi Arabia... Be concise, professional, and insightful. Provide strategic advice and summaries.' },
                { id: 'layla', name: 'Layla Al-Farsi', title: 'Data Analytics Agent', largeImg: 'https://easy-peasy.ai/cdn-cgi/image/quality=80,format=auto,width=700/https://media.easy-peasy.ai/27feb2bb-aeb4-4a83-9fb6-8f3f2a15885e/3f6fb035-158b-47f1-8c69-5fe9a407d4f2.png', smallImg: 'https://easy-peasy.ai/cdn-cgi/image/quality=80,format=auto,width=700/https://media.easy-peasy.ai/27feb2bb-aeb4-4a83-9fb6-8f3f2a15885e/3f6fb035-158b-47f1-8c69-5fe9a407d4f2.png', description: 'As your data expert, I provide your Highness with key insights from around HRSD, identify trends, and offer detailed analytical support for your objectives.', systemPrompt: 'You are Layla Al-Farsi, a Data Analytics Agent for HRSD in Saudi Arabia. Your Highness requires data-driven insights. ALWAYS respond with concise analysis, key findings, and data points. When a visualization is appropriate (e.g., trends, comparisons), provide the necessary data in a Chart.js-compatible JSON format strictly enclosed within `[CHART_DATA:{...}]`. The JSON MUST be complete and valid. It MUST contain "type" (e.g., "bar", "line", "pie"), "labels" (array of strings), and "datasets" (array of objects, each with "label" and "data" properties). Example: `[CHART_DATA:{"type": "bar", "labels": ["Q1", "Q2"], "datasets": [{"label": "Metric A", "data": [10, 15]}]}]` Always include a brief textual explanation of the chart\'s insights immediately following the chart data marker. Focus strictly on providing analytical insights derived from data. Avoid conversational filler unless specifically asked.' },
                { id: 'omar', name: 'Omar Mansour', title: 'AI Coordinator', largeImg: 'https://easy-peasy.ai/cdn-cgi/image/quality=80,format=auto,width=700/https://media.easy-peasy.ai/2f8cd8b2-88d5-4865-b07e-cafd6403b72b/bd99faca-67c4-4cc3-895e-06bed59a08d2.png', smallImg: 'https://easy-peasy.ai/cdn-cgi/image/quality=80,format=auto,width=700/https://media.easy-peasy.ai/2f8cd8b2-88d5-4865-b07e-cafd6403b72b/bd99faca-67c4-4cc3-895e-06bed59a08d2.png', description: 'As your operational specialist, I manage schedules, coordinate between departments, and provide logistical support to ensure operational smoothness.', systemPrompt: 'You are Omar Mansour, an AI Coordinator for HRSD... Focus on logistics, scheduling, action items, and ensuring operational smoothness.' }
            ];
            let currentPersonaId = 'hakim';
            let chatHistory = [];
            let selectedText = '';
            const today = new Date('2025-10-22T09:23:00+03:00');

            // --- DOM Elements ---
            const mainPersonaImage = document.getElementById('mainPersonaImage');
            const mainPersonaName = document.getElementById('mainPersonaName');
            const mainPersonaTitle = document.getElementById('mainPersonaTitle');
            const personaModal = document.getElementById("personaModal");
            const eventModal = document.getElementById("eventModal");
            const meetingsModal = document.getElementById("meetingsModal");
            const dayActionModal = document.getElementById("dayActionModal");
            const messageModal = document.getElementById("messageModal");
            const changePersonaBtn = document.getElementById('changePersonaBtn'); // Desktop only now
            const newChatBtn = document.getElementById('newChatBtn'); // Mobile new chat button
            const closeModalBtns = document.querySelectorAll('.close-button');
            const personaOptionsContainer = document.getElementById('personaOptions');
            const navButtonsDesktop = document.querySelectorAll('.nav-tabs .nav-button'); // Desktop Tabs
            const mobileNav = document.getElementById('mobileNav'); // Mobile nav overlay
            const mobileNavLinks = document.querySelectorAll('.mobile-nav-menu .nav-link'); // Mobile nav links
            const navBackdrop = document.getElementById('navBackdrop');
            const pages = document.querySelectorAll('.page-content');
            const chatInput = document.getElementById('chatInput');
            const sendBtn = document.getElementById('send-btn');
            const chatMessages = document.getElementById('chatMessages');
            const askAgentBtn = document.getElementById('ask-agent-btn');
            const summaryContent = document.getElementById('summary-content');
            const mobileMenuBtn = document.querySelector('.mobile-menu-btn');
            const chatActionBtn = document.getElementById('chat-action-btn'); // '+' button in input
            const messageModalTitle = document.getElementById("message-modal-title");
            const messageModalText = document.getElementById("message-modal-text");
            const copySummaryBtn = document.getElementById("copy-summary-btn");

            // --- Function Definitions ---

            // --- Persona Management ---
            function updatePersonaUI(personaId, isInitialLoad = false) {
                 const persona = personaData.find(p => p.id === personaId);
                if (!persona) return;
                // Update desktop persona display if it exists
                if(mainPersonaImage) mainPersonaImage.src = persona.largeImg;
                if(mainPersonaName) mainPersonaName.textContent = persona.name;
                if(mainPersonaTitle) mainPersonaTitle.textContent = persona.title;
                // Update all agent avatars in chat
                document.querySelectorAll('[data-persona-avatar]').forEach(img => {
                    img.src = persona.smallImg;
                });
                const oldPersonaId = currentPersonaId;
                currentPersonaId = personaId;
                // If persona changed (not initial load), reset chat
                if (!isInitialLoad && oldPersonaId !== currentPersonaId) {
                    chatHistory = [];
                   if (chatMessages) chatMessages.innerHTML = '';
                    displayNewPersonaGreeting(persona);
                }
            }

            function displayNewPersonaGreeting(persona) {
                 let greeting = `Welcome your Highness. As-salāmu 'alaykum. I am ${persona.name}. ${persona.description} How may I be of service to your Highness today?`;
                 displayMessage('agent', greeting);
                 if(chatHistory.length === 0 || chatHistory[chatHistory.length-1]?.parts?.[0]?.text !== greeting) {
                    chatHistory.push({ role: 'model', parts: [{ text: greeting }] });
                 }
            }

            function renderPersonaOptions() {
                 if (!personaOptionsContainer) return;
                personaOptionsContainer.innerHTML = '';
                personaData.forEach(persona => {
                    const div = document.createElement('div');
                    div.className = `persona-option ${persona.id === currentPersonaId ? 'selected' : ''}`;
                    div.innerHTML = ` <img src="${persona.smallImg}" alt="${persona.name}"> <div class="persona-details"> <h4>${persona.name} - ${persona.title}</h4> <p>${persona.description}</p> </div> `;
                    div.addEventListener('click', () => {
                        updatePersonaUI(persona.id);
                        closeModal(personaModal);
                         // If on mobile, ensure agent page is active after selection
                        if (window.innerWidth <= 768) {
                           switchPage('agent-page'); // Switch to agent page
                        }
                    });
                    personaOptionsContainer.appendChild(div);
                });
            }

            // --- Modal Management ---
            function openModal(modal) { if (!modal) return; if (modal === personaModal) renderPersonaOptions(); modal.style.display = "flex"; }
            function closeModal(modal) { if (!modal) return; modal.style.display = "none"; }
            function showMessageModal(text, title = 'Notice') { if(messageModalTitle) messageModalTitle.textContent = title; if(messageModalText) messageModalText.textContent = text; if(messageModal) openModal(messageModal); }

            // --- Page Switching ---
            function switchPage(targetId) {
                 const targetPage = document.getElementById(targetId);
                 // Hide all pages
                 pages.forEach(page => { if (page) page.classList.remove('active'); });
                 // Show target page
                 if (targetPage) { targetPage.classList.add('active'); }
                 else { console.error(`Target page with ID "${targetId}" not found.`); }

                 // Update desktop nav button states
                 navButtonsDesktop.forEach(btn => {
                     if (btn.dataset.target === targetId) { btn.classList.add('active'); }
                     else { btn.classList.remove('active'); }
                 });
                 // Update mobile nav link states
                 mobileNavLinks.forEach(link => {
                     if (link.dataset.target === targetId) { link.classList.add('active'); }
                     else { link.classList.remove('active'); }
                 });

                 // Close mobile nav if open
                 if (mobileNav && mobileNav.classList.contains('active')) {
                     mobileNav.classList.remove('active');
                     if(navBackdrop) navBackdrop.classList.remove('active');
                 }
            }


            // --- Agenda & Calendar ---
            function setupAgendaInteractions() { /* ... agenda interaction setup ... */ }
            function openEventModal(title, time, details) { /* ... event modal logic ... */ }
            function switchToAgentAndSendPrompt(prompt, targetPersonaId = null) {
                closeModal(eventModal); closeModal(dayActionModal); closeModal(meetingsModal);
                if (targetPersonaId && targetPersonaId !== currentPersonaId) { updatePersonaUI(targetPersonaId); }
                // Ensure agent page is active
                switchPage('agent-page');
                if (chatInput) {
                    chatInput.value = prompt;
                    // Need a slight delay if persona just switched for greeting
                    if (targetPersonaId && targetPersonaId !== currentPersonaId) { setTimeout(handleSendMessage, 100); }
                    else { handleSendMessage(); }
                }
            }
            function openMeetingsModal(topicId, topicTitle) { /* ... meetings modal logic ... */ }
            function takeActionFromTopic(prompt) { /* ... topic action logic ... */ }
            function updateTodaysAgendaPanel() { /* ... summary panel logic ... */ }
            function setupCalendarToggles() { /* ... calendar view toggle logic ... */ }
            function renderDesktopMonthCalendar() { /* ... desktop month calendar rendering ... */ }
            function openDayActionModal(dateStr) { /* ... day action modal logic ... */ }
            function renderTodayView() { /* ... desktop today view rendering ... */ }
            function initMobileCalendar() { /* ... mobile calendar rendering ... */ }


            // --- Chat & Gemini API ---
            function displayMessage(sender, text) { /* ... display message logic (handles bubbles/no bubbles via CSS)... */
                if (!chatMessages) { console.error("chatMessages element not found."); return; }
                const persona = personaData.find(p => p.id === currentPersonaId);
                const avatarSrc = sender === 'user' ? 'https://placehold.co/40x40/28a745/ffffff?text=A' : (persona ? persona.smallImg : 'https://placehold.co/40x40/00A99D/ffffff?text=AI');
                const messageBubble = document.createElement('div'); messageBubble.className = `message-bubble ${sender}`;
                const avatarImg = document.createElement('img'); avatarImg.src = avatarSrc; avatarImg.alt = `${sender} Avatar`; avatarImg.className = 'avatar'; if (sender === 'agent') { avatarImg.setAttribute('data-persona-avatar', ''); }
                messageBubble.appendChild(avatarImg);
                const contentDiv = document.createElement('div'); contentDiv.className = 'content';
                let chartData = null; let textContent = text; let canvasId = null; const chartMarkerStart = '[CHART_DATA:'; const chartMarkerEnd = ']';
                if (sender === 'agent') {
                    const startIndex = text.indexOf(chartMarkerStart); const endIndex = text.lastIndexOf(chartMarkerEnd);
                    if (startIndex !== -1 && endIndex > startIndex) { const jsonString = text.substring(startIndex + chartMarkerStart.length, endIndex).trim(); if (jsonString.startsWith('{') && jsonString.endsWith('}')) { try { chartData = JSON.parse(jsonString); if (chartData.type && chartData.labels && chartData.datasets) { textContent = text.substring(0, startIndex).trim() + text.substring(endIndex + chartMarkerEnd.length).trim(); canvasId = `chart-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`; const chartContainer = document.createElement('div'); chartContainer.className = 'chart-container'; chartContainer.innerHTML = `<canvas id="${canvasId}"></canvas>`; contentDiv.appendChild(chartContainer); } else { console.error("Parsed chart JSON missing required properties.", chartData); chartData = null; textContent = text; } } catch (e) { console.error("Failed to parse chart JSON:", e, "JSON string:", jsonString); textContent = text; chartData = null; } } else { console.warn("Potential chart data invalid:", jsonString); textContent = text; chartData = null; } }
                    if (textContent && typeof marked !== 'undefined' && marked.parse) { try { const textDiv = document.createElement('div'); textDiv.innerHTML = marked.parse(textContent); contentDiv.insertBefore(textDiv, contentDiv.firstChild); } catch (e) { console.error("Markdown parsing error:", e); const textDiv = document.createElement('div'); textDiv.textContent = textContent; contentDiv.insertBefore(textDiv, contentDiv.firstChild); } } else if (textContent) { const textDiv = document.createElement('div'); textDiv.textContent = textContent; contentDiv.insertBefore(textDiv, contentDiv.firstChild); }
                } else { contentDiv.textContent = textContent; }
                messageBubble.appendChild(contentDiv);
                if (chatMessages) { chatMessages.appendChild(messageBubble); if (chartData && canvasId && sender === 'agent') { setTimeout(() => { const canvasElement = document.getElementById(canvasId); if (canvasElement) { renderChart(canvasElement, chartData); } else { console.error(`Canvas ${canvasId} not found.`); } setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 100); }, 0); } else { setTimeout(() => chatMessages.scrollTop = chatMessages.scrollHeight, 0); } } else { console.error("chatMessages element not found."); }
            }
             function renderChart(canvasElement, chartData) {
                 if (!canvasElement || !chartData || !chartData.type || !chartData.labels || !chartData.datasets) {
                     console.error("renderChart: Invalid chart data or canvas element.", {canvas: !!canvasElement, data: chartData});
                     if (canvasElement?.parentElement) { canvasElement.parentElement.innerHTML = "<p style='color: #ffcccc;'>Could not render chart: Invalid data provided.</p>"; }
                     return;
                 }
                 const ctx = canvasElement.getContext('2d');
                 if (!ctx) {
                     console.error("renderChart: Could not get canvas context.");
                     if (canvasElement?.parentElement) { canvasElement.parentElement.innerHTML = "<p style='color: #ffcccc;'>Could not render chart: Canvas context error.</p>"; }
                     return;
                 }
                 console.log("Rendering chart with data:", JSON.stringify(chartData)); // Log valid data before rendering

                 const options = {
                     responsive: true, maintainAspectRatio: true,
                     plugins: { legend: { labels: { color: 'rgba(255, 255, 255, 0.8)' } } },
                     scales: {
                         y: { beginAtZero: true, ticks: { color: 'rgba(255, 255, 255, 0.7)', font: { family: 'Poppins' } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                         x: { ticks: { color: 'rgba(255, 255, 255, 0.7)', font: { family: 'Poppins' } }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                     }
                 };

                 const defaultBackgroundColors = ['rgba(0, 169, 157, 0.6)', 'rgba(255, 193, 7, 0.6)', 'rgba(0, 123, 255, 0.6)', 'rgba(220, 53, 69, 0.6)', 'rgba(40, 167, 69, 0.6)', 'rgba(23, 162, 184, 0.6)'];
                 const defaultBorderColors = ['rgba(0, 169, 157, 1)', 'rgba(255, 193, 7, 1)', 'rgba(0, 123, 255, 1)', 'rgba(220, 53, 69, 1)', 'rgba(40, 167, 69, 1)', 'rgba(23, 162, 184, 1)'];

                 chartData.datasets.forEach((dataset, index) => {
                     if (!Array.isArray(dataset.data)) { console.warn(`Dataset ${index} has invalid 'data'. Using empty array.`); dataset.data = []; }
                     // Assign colors based on chart type
                     const colorIndex = index % defaultBackgroundColors.length;
                     if (chartData.type === 'line' || chartData.type === 'radar') {
                        dataset.backgroundColor = dataset.backgroundColor || defaultBackgroundColors[colorIndex].replace('0.6', '0.2');
                        dataset.borderColor = dataset.borderColor || defaultBorderColors[colorIndex];
                        dataset.tension = 0.1; // Make lines slightly curved
                     } else if (chartData.type === 'pie' || chartData.type === 'doughnut') {
                        // For pie/doughnut, backgroundColor should be an array matching data length
                        dataset.backgroundColor = dataset.backgroundColor || dataset.data.map((_, i) => defaultBackgroundColors[i % defaultBackgroundColors.length]);
                        dataset.borderColor = dataset.borderColor || defaultBorderColors[0].replace('1', '0.2'); // Use a subtle border or make it transparent
                        dataset.borderWidth = 1;
                     } else { // bar, etc.
                        dataset.backgroundColor = dataset.backgroundColor || defaultBackgroundColors[colorIndex];
                        dataset.borderColor = dataset.borderColor || defaultBorderColors[colorIndex];
                        dataset.borderWidth = 1;
                     }
                 });

                 try {
                     // Destroy previous chart instance if it exists
                     const existingChart = Chart.getChart(ctx);
                     if (existingChart) {
                         existingChart.destroy();
                     }
                     // Create new chart
                     new Chart(ctx, { type: chartData.type, data: { labels: chartData.labels, datasets: chartData.datasets }, options: options });
                 } catch (e) {
                     console.error("Chart.js rendering error:", e, "Data:", chartData);
                     if (canvasElement?.parentElement) { canvasElement.parentElement.innerHTML = "<p style='color: #ffcccc;'>Error rendering chart data.</p>"; }
                 }
             }
            function showTypingIndicator() { /* ... typing indicator logic ... */ }
            function removeTypingIndicator() { /* ... typing indicator logic ... */ }
            async function handleSendMessage() { /* ... send message logic ... */
                 if (!chatInput) return; const userMessage = chatInput.value.trim(); if (!userMessage) return; displayMessage('user', userMessage); chatHistory.push({ role: 'user', parts: [{ text: userMessage }] }); chatInput.value = ''; showTypingIndicator(); await sendMessageToGemini(userMessage);
             }
            async function sendMessageToGemini(message, retries = 3, delay = 1000) { /* ... Gemini API call logic ... */
                 const apiKey = "AIzaSyAJGvnZX6uuTlAnf_m0hCQFJ3knsJRnGIU";  const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`; const persona = personaData.find(p => p.id === currentPersonaId); const systemPromptText = persona ? persona.systemPrompt : 'You are a helpful assistant.'; const payload = { contents: chatHistory, systemInstruction: { parts: [{ text: `${systemPromptText} User is "Your Highness". Current date: ${new Date().toLocaleString('en-US', { timeZone: 'Asia/Riyadh' })}.` }] }, generationConfig: { maxOutputTokens: 8192, }, safetySettings: [ { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' }, { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_MEDIUM_AND_ABOVE' }, { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' }, { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_MEDIUM_AND_ABOVE' }, ] };
                 try { const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); removeTypingIndicator(); if (!response.ok) { if (!(response.status === 429 || response.status >= 500)) { console.error(`API Error: ${response.status} ${response.statusText}`, await response.text()); } if ((response.status === 429 || response.status >= 500) && retries > 0) { await new Promise(resolve => setTimeout(resolve, delay)); return sendMessageToGemini(message, retries - 1, delay * 2); } throw new Error(`API error: ${response.status} ${response.statusText}`); } const result = await response.json(); const candidate = result.candidates?.[0]; const agentResponseText = candidate?.content?.parts?.[0]?.text; if (agentResponseText) { displayMessage('agent', agentResponseText); chatHistory.push({ role: 'model', parts: [{ text: agentResponseText }] }); } else { let errorText = "Apologies, couldn't process fully."; if (candidate?.finishReason && candidate.finishReason !== 'STOP') { errorText = `Response stopped: ${candidate.finishReason}.`; console.warn("Gemini finishReason:", candidate.finishReason, candidate.safetyRatings); } else if (result.promptFeedback?.blockReason) { errorText = `Prompt blocked: ${result.promptFeedback.blockReason}.`; console.warn("Gemini promptFeedback:", result.promptFeedback); } else if (!agentResponseText) { console.warn("Gemini response missing text:", result); errorText = "Received empty response."; } displayMessage('agent', errorText); } } catch (error) { console.error('Error fetching from Gemini API:', error.message); removeTypingIndicator(); displayMessage('agent', "Network difficulties connecting. Please try again."); }
            }


            // --- UI & Event Listeners ---
            function setViewportHeight() { let vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }

            // --- Event Listeners ---
            // Mobile Menu Toggle
            if (mobileMenuBtn && mobileNav && navBackdrop) {
                mobileMenuBtn.addEventListener('click', () => {
                    mobileNav.classList.toggle('active');
                    navBackdrop.classList.toggle('active');
                });
                navBackdrop.addEventListener('click', () => { // Close on backdrop click
                    mobileNav.classList.remove('active');
                    navBackdrop.classList.remove('active');
                });
            }
            // Mobile Navigation Links
            if (mobileNavLinks) { mobileNavLinks.forEach(link => { link.addEventListener('click', (e) => { e.preventDefault(); const targetId = link.dataset.target; switchPage(targetId); }); }); }
            // Desktop Navigation Tabs
            if (navButtonsDesktop) { navButtonsDesktop.forEach(button => { button.addEventListener('click', () => { const targetId = button.dataset.target; switchPage(targetId); }); }); }
            // Modal close buttons
            closeModalBtns.forEach(btn => { btn.addEventListener('click', () => { const modal = btn.closest('.modal'); if (modal) closeModal(modal); }); });
            window.addEventListener('click', (event) => { if (event.target.classList.contains('modal')) { closeModal(event.target); } });
            // Copy summary button
            if (copySummaryBtn) { copySummaryBtn.addEventListener('click', () => { /* ... copy logic ... */ }); }
            // Persona change button (Desktop) / New Chat (Mobile)
            if (changePersonaBtn) { changePersonaBtn.addEventListener('click', () => openModal(personaModal)); }
            if (newChatBtn) { newChatBtn.addEventListener('click', () => openModal(personaModal)); }
            // Send button and Enter key
            if (sendBtn) { sendBtn.addEventListener('click', handleSendMessage); }
            if (chatInput) { chatInput.addEventListener('keydown', (event) => { if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); handleSendMessage(); } }); }
            // Topic card actions
            document.querySelectorAll('.topic-action-btn').forEach(button => { button.addEventListener('click', () => { /* ... topic actions ... */ }); });
            // "Ask Agent" on text selection
            document.addEventListener('mouseup', (e) => { /* ... ask agent logic ... */ });
            document.addEventListener('mousedown', (e) => { /* ... ask agent logic ... */ });
            if (askAgentBtn) { askAgentBtn.addEventListener('click', (e) => { /* ... ask agent logic ... */ }); }
            // Quick Actions
            document.querySelectorAll('.quick-action-btn').forEach(btn => { btn.addEventListener('click', () => { /* ... quick actions ... */ }); });
            // Chat "+" Action Button
            chatActionBtn?.addEventListener('click', (e) => { /* ... chat action '+' logic ... */ });
            // Tool Card Actions
             document.querySelectorAll('.tool-action-btn').forEach(button => { button.addEventListener('click', () => { /* ... tool actions with persona switch ... */
                 const action = button.dataset.toolAction; const card = button.closest('.tool-card'); if (!card) return; const toolTitleEl = card.querySelector('.tool-title'); if (!toolTitleEl) return; const toolTitle = toolTitleEl.textContent; let targetPersonaId = 'hakim'; let prompt = `Tell me more about the "${toolTitle}" AI tool.`;
                 switch(action) { case 'visualize': case 'predict': case 'sentiment': targetPersonaId = 'layla'; prompt = `Assist with ${toolTitle}. Data needed?`; break; case 'summarize': targetPersonaId = 'hakim'; prompt = `Help use ${toolTitle} tool or summarize something.`; break; case 'schedule': targetPersonaId = 'omar'; prompt = `Help schedule meeting with ${toolTitle}.`; break; case 'risk': targetPersonaId = 'hakim'; prompt = `Help use ${toolTitle} to assess risk for [Area/Project]?`; break; }
                 switchToAgentAndSendPrompt(prompt, targetPersonaId);
             }); });


            // --- INITIALIZATION ---
            setViewportHeight();
            window.addEventListener('resize', setViewportHeight); // Recalculate on resize/orientation change
            setupCalendarToggles();
            updatePersonaUI(currentPersonaId, true); // Initialize with default persona
            updateTodaysAgendaPanel();
            setupAgendaInteractions();
            initMobileCalendar();
            renderDesktopMonthCalendar();
            renderTodayView();

            // Initial Page Setup (ensure agent page is shown by default)
            switchPage('agent-page');

        });
    </script>
</body>
</html>

